                      ПРОГРАММА ОПИСАНИЕ
Программа реализована по модульному принципу на языке Фортран 77 в системе VF6.6
Так же используются модули из библиотеки ГРАФОР 4.20 ИПМ АН СССР (GRAFOR65.OBG).
Проект GRAFM.dsp в директории (C:\WORK\Projects\GRAFM) состоит из модулей
(OPEN.FOR A.FOR B.FOR C.FOR D.FOR E.FOR F.FOR G.FOR H.FOR J.FOR) и частей
вспомогательных (Namelist.FOR_PARAM.FOR_COMON.FOR), оформленных в виде файлов.
  Для расчетов используются физические константы[д.1] и нормированные величины.
Физические координаты равны сеточным * коэффициент масштабирования Z0.
!значения потенциала и объемного заряда хранятся в одномерных массивах F() FP() 
     NK1 /1/ !канал записи массива потенциала        F(IDIM=IRL1*IZL1)
     NK2 /2/ !канал записи траекторий трубок тока
     NK3 /3/ !канал записи массива обьемного заряда FP(IDIM=IRL1*IZL1)
     NK4 /4/ !канал записи эквипотенциалей
     NK5 /5/ !
     NK5 /6/ !
!
  При запуске (OPEN):Program OPEN резервирует память для общих блоков и
организует считывание файла входных данных по UNIT=10,   FILE='nametest.dat'.
  Вывод листинга в файла выходных данных по UNIT=NOUT,   FILE='CHECKERR.TXT'.
Считывание входных данных по namelist namelist /input0/.После этого открывает
файл вывода координат граничного контура по UNIT=11, FILE='11.TXT' и каналы 1-6
открывает, организует загрузку пр-м по плану, указанному во вводимых данных.
!
  При вызове модуля (A):FDATA1 строится массив-описатель области(MOO),
задающий информацию о форме области на сетке размером (IZL1,IRL1). Граница
области задается порядковыми номерами ее граничных точек на сетке, хранящихся в
массивах IZ(K), IR(K), K = 1, ..., NK.
  Существует несколько возможностей проводить расчет траекторий в заданых полях.
Инжекция частиц в расчетную область начиная с поверхности эмиссии (ISTART=0).
Либо инжекцию с заданными начальными координатами и параметрами (ISTART=1)
трубок тока (ТТ). Необходимо сохранять эти величины в файле данных, чтобы потом
иметь возможность продолжать расчет ЭОС, считывая их для каждой ТТ. В блоке
COMMON/COM27/ хранятся флаги ISTART и NAMCAT и переменные для условий инжекции.
!
  При вызове модуля (C):START
CC     проверяем ZNAK 
Если параметр ZNAK больше 0, то
  -присваиваем PMA = 1.E+6*EPS0*DSQRT(2.*DEL) !нормировка физической плотности тока
  -присваиваем BN = SQRT(2.*FG/DEL)/Z0 ! нормировка магнитной индукции, Wb/m/m
Если параметр ZNAK меньше 0, то
  -присваиваем PMA =1.E+6*EPS0*DSQRT(2.*DIO/28.)
  -присваиваем BN = SQRT(2.*FG/DIO/28.)/Z0
CC     программа готовит начальные координаты инжекции ТТ с заданной поверхности
CC     печатает значения параметров задачи
-определяем значение PJA
-присваиваем NAMCAT='CATOD1'
Если NUMB=0--можно выполнить расчет только вакуумного потенциала
Если NUMB<0 пропускаем определение координат точек эмиссии на дуге окружности.
При NUMB<0 значения для начальных координат считываются в свободном формате из
файла по каналу 10 и это необходимо сделать до вызова п/п-мы START. 
  Продольные и поперечные координаты точек эмиссии U(0:N4),V(0:N4) для инжекции,
расстояния от эмитирующей поверхности DR, число ТТ IZZ хранятся в COMMON/COM20/.
При NUMB>0 осевое сечение поверхности эмиссии это дуга окружности на граничном
контуре, начальный узел которой имеет номер NUMB. Угол отсчитывается от оси
симметрии против часовой стрелки. Поверхность эмиссии разбивается на сегменты
одинаковой угловой величины. Массивы продольных U() и поперечных координаты V()
точек середины сегментов определяются. После значение параметра NAMCAT='CATOD2'.
 При NAMCAT='CATOD1' в массивах U(0:N4),V(0:N4) находятся координаты граничных
точек сегментов эмиссии. Итоговое значение NUMB=ABS(NUMB) берется по модулю.  
!
  При вызове модуля (D):FPOTE
Если требуемая размерность массивов IDIM1=IRL1 х IZL1 больше IDIM, то программа
останавливается с выдачей *******IDIM=9966.
-Определяем IDIM1 к-во узлов сетки размером (IZL1,IRL1)
-Матрицу объемного заряд записываем в файл по логическому каналу 3    !ЭТО НЕ
 ДЕЛАТЬ, ЕСЛИ НАДО, ТО НАСЧИТЫВАТЬ массив FP(IDIM) перед выполнением пр-мой!!!! 
-Обнуляем матрицу потенциала F(), а потом насчитывать её
-Увеличиваем значение NITER счетчика выполнения расчетов матрицы потенциала F()
-Обнуляем значение первеанса PERVO=0. и присваиваем Q1=1 и ITER=0
-Итерационно выполняем вызов модуля расчета POISON, проверяя значение флага MTWR
-После достижения заданной точности присваиваем значение корректирующему
 множителю GAMA
-Выдаем на печать значения NITER, ITER, GAMA, ABSE и времени расчета матрицы потенциала
-Итерационно выполняем вызов модуля расчета POISON, проверяя значение флага MTWR
-Матрицу потенциала записываем в файл по логическому каналу 1
-При NUMB=0 происходит выход из программы
-Обнуляем матрицу объемного заряда FP(),
-Присваиваем значение MTWR= параметр печати
!
  Траектории ТТ с поверхности эмиссии идут прямолинейно как в плоском диоде с
пространственным зарядом на расстояние DR до точек СТАРТА. Для каждой ТТ
координаты СТАРТА рассчитываются при ISTART=0 либо считываются при ISTART=1 из
файла данных(в п/п-ме INTGR либо INTGF). Кол-во разбиений пов-сти эмиссии IZZ задано (М2)
!
  При вызове модуля (J):INTGR для расчета объемного заряда в узлах сетки:
-если ISTART=0 обнуляем значение первеанса PERVO=0. и присваиваем Q1=1.;
-если ISTART=1 считываем нач.условия траекторий и присваиваем Q1=0.;
-выводим заголовок;
-присваиваем значение корректирующему множителю GAMA;
-В цикле для каждой ТТ:
  если ISTART=1 присваиваем значение флагу прохождения прикатодного слоя L=1;
  если ISTART=0, то
  -находим продольную Y1 и поперечную Y2 координаты точек СТАРТА; 
  -находим значение потенциала POTX() точки СТАРТА; 
  -находим значение скорости VO ТТ в точке СТАРТА;
  -корректируем значение плотности тока инжекции UVOX(); 
  -находим координаты Y() в точке ЭМИССИИ; 
  -присваиваем значение флагу прохождения прикатодного слоя L=0;
 Присваиваем значение IGMA=1
!
  При вызове модуля (J):INTEGR
-если ISTART=0 выдаем значение первеанса PERVO, напряжения FG, тока и NITER 
!
  Если ISTART=1, то в п/п-мах INTGR либо INTGF выполняем:
-по каналу 6 считываются физические координаты U(0),V(0) и нормируются;
  Если ISTART=0, то определяем:
-для шагов NITER >= NITM по каналу 5 записываются U(0)*Z0,V(0)*Z0;
-в п/п-ме INTGR присваиваются значения Q1=1 и микропервеанс инжектора PERVO=0.
  Если ISTART=1, то для каждой ТТ:
-считываются по канал 6 физические начальные условия и нормируются;
-присваиваются флаг непрохождения приэмиссионного слоя L=1; и вычисляется
 длина сегмента интегрирования AL0;
При NAMCAT='CATOD1' вычисляем поперечную длину AL0 и координаты точек СТАРТА
по массивам U(0:N4),V(0:N4) в область расчета на расстояние DR.
При NAMCAT='CATOD2' определим значение координат точек СТАРТА на расстоянии DR
от середины дуги эмиссии по направлению нормали в  область задачи. Для
определения плотности тока эмиссии необходимо значение разности потенциалов
между точками старта и эмиссии. Для электронов и отрицательных ионов эта
величина положительная, а для положительных ионов отрицательная. Значение
потенциала в точках СТАРТА находим обратной билинейной интерполяцией в п/п-ме
FORCE, как и в других точках области расчета. Флаг работы п-мы IGMA, который
хранится в COMMON/COM15/, обращается в 0, если координаты точки выходят
за границы области расчета. Зная номер поверхности эмиссии NUMB и ее потенциал,
легко вычислить разность потенциалов между эмиттером и точкой СТАРТА. Квадратный
корень из нее определяет нормированную скорость VO. Эта величина хранится в 
COMMON/COM27/. Куб этой скорости UVO определяет плотность тока эмиссии.
 Потенциал в точках СТАРТА для каждой ТТ записывается в массив POTX(N4). Куб
скорости в точках СТАРТА для каждой трубки тока записывается массив UVOX(N4)
-используя параметр GAMA вычисляется коррекция тока эмиссии, т.к. корректируется
массив значений кубов UVOX(N4) и соответственно плотность тока эмиссии;
Микропервеанс, массив потенциала точки старта, параметр Q1, массив куба скорости
в точке старта хранятся в COMMON/COM22/PERVO,POTX(N4),Q1,UVOX(N4).
  Для того чтобы видеть изменение параметров каждой трубки тока на каждом шаге
приближения используют массивы UVX(N4) для RATIO OF CURRENT DENCITY FOR FG=..(V)
и PTX(N4) для START POINT POTENTIALS NORMALIZED FOR FG=...(V).
-присваиваются значения начальным координатам и нулевые значения скоростям;
  При NAMCAT='CATOD1' присваиваем начальным координатам координаты середины
сегмента эмиссии. При NAMCAT='CATOD2' присваиваем начальным координатам
координаты точек эмиссии из массивов UX,VY.
-вычисляем заряд переносимый каждой трубкой тока, площадь сегмента инжекции и
вклад в микропервеанс от каждой трубки тока[дополнение 2];
-присваиваются флаг прохождения приэмиссионного слоя L=0.
  Далее определяются координаты траектории в п/п-ме INTEGR либо INTEGF.
  При L=0 траектории в прикатодном слое до точек СТАРТА вычисляются по формулам
для плоского диода с пространственным зарядом при заданном распределении
потенциала. Значение скорости определяется разностью потенциалов между точками
эмисси и СТАРТА. Влиянием магнитного поля на траекторию пренебрегаем. Для
определения координат и скоростей точек СТАРТА при NAMCAT='CATOD1' используется
п/п-ма CATOD1. При NAMCAT='CATOD2' используется п/п-ма CATOD2.
  При L=1 от точек СТАРТА интегрируем уравнения движения по времени. Шаг по
времени выбирается так, чтобы координаты изменялись меньше, чем на шаг сетки.
Обе программы выполняют интегрирование одинаково по методу Рунге-Кутта-Мерсона.
Этот явный одношаговый метод является весьма надежным. Приведем формулы
 Y(Tn+1)=Y(Tn)+1/6*(K0+4*K3+K4), где K0=h*f(Tn,Yn); K1=h*f(Tn+1/3*h,Yn+1/3*K0);
 K2=h*f(Tn+1/3*h,Yn+1/6*K0+1/6*K1); K3=h*f(Tn+1/2*h,Yn+1/8*K0+3/8*K2);
 K4=h*f(Tn+h,Yn+1/2*K0-3/2*K2+2*K3); f(Tn,Yn)-вектор правых частей уравнений
движения[д.3] в точке (Tn,Yn). При этом ошибка расчета на шаге не определяется.
  В п/п-ме INTEGR при пошаговом интегрировании также происходит заполнение
матрицы плотности заряда. Вычисляя заряд переносимый ТТ вблизи узла разностной
сетки определяем вклад в плотность для данного узла. Заряд равен току трубки
умноженному на шаг по времени. Шаг по времени разбиваем на три части. Имея
начальную  и конечные скорости на шаге вычисляем среднее и считаем, что весь шаг
по времени частица проходит с этой скоростью. Вычисляем заряд и координаты
траектории в каждой из трех частей при заданной скорости. Далее методом обратной
билинейной интерполяции распределяем заряд по четырем узлам прямоугольника, в
котором находится точка траектории при данной части шага по времени. 
  В п/п-ме INTEGF происходит расчет траектории и запись координат в выходной
файл по каналу 2. 
 Если расчет только при наличии электрического поля, то выводятся
N Z-KOOP. R-KOOP. Z-SPEED. R-SPEED L-SPEED CHARGE. При наличии магнитного поля
выводятся N Z-KOOP. R-KOOP. Z-SPEED. R-SPEED L-SPEED F-SPEED TOTAL-SPEED CHARGE.
В поле CHARGE выводится заряд, уносимый одним радианом ТТ за время шага DT.
9:07 28.05.2018